# Magnetic Leverless Controller (自作磁気接点レバーレス)

本プロジェクトは、磁気スイッチ（ホールセンサー）を採用した超低遅延・高機能な競技用レバーレスコントローラーの開発プロジェクトです。

卒業制作の一環として制作されており、進捗に合わせて随時コードやデータの更新を行います。

---

## 概要

従来の物理接点スイッチではなく、磁力による非接触検知を採用することで、物理的な摩耗を抑えつつ、ミリ単位での高度な入力制御を実現しています。

### 主な機能
- **ラピッドトリガー (Rapid Trigger):** 指の上げ下げに即座に反応する超高速入力を実現。
- **可変作動点 (Actuation Point):** 反応する深さを 0.1mm 単位でカスタマイズ可能。
- **Web Configurator:** 専用ソフト不要。ブラウザからリアルタイムに設定変更・モニタリングが可能。
- **SOCDクリーナー:** 競技ルールに準拠した同時押し処理（ニュートラル優先、後押し優先等）を実装。
- **コンボボタン機能:** 1つのボタンで複数のボタン同時押しを再現する補助機能（C1～C4）。
- **入力切断機能:** 設定中の誤入力を防ぐためのセーフティ機能。

---

## ハードウェア設計

設計データはすべて `PCB` フォルダ内に格納されています。

- **基板データ (PCB Design):** 回路図および基板発注用のガーバーデータ。
- **筐体データ (Acrylic Case):** レーザーカット用のアクリルパネル設計データ。

### 主要コンポーネント
- **MCU:** STM32F303CBT6
- **センサー:** GH39F ホールセンサー
- **スイッチ:** - デフォルト: Gateron Magnetic Jade Ultra (3.2mmストローク)
  - 特別仕様: Gateron Magnetic Jade Pro (3.5mmストローク)
- **マルチプレクサ:** ADG708

> [!NOTE]
> 本リポジトリの標準ファームウェアは **3.2mmストローク (Jade Ultra)** に最適化されています。
> 3.5mmストロークのスイッチを使用する場合は、`main.c` 内の `TRAVEL_DISTANCE_MM` を `3.5f` に変更してビルドしてください。

---

## ディレクトリ構成

## 導入手順

### 1. ファームウェアの書き込み
1. [STM32CubeProgrammer](https://www.st.com/ja/development-tools/stm32cubeprog.html) をダウンロードしてPCにインストールします。
2. PCと基板をUSBケーブルで接続し、STM32CubeProgrammerを起動します。
3. 画面右側の接続メニューから「USB」を選択し、「Port」のドロップダウンから適切なポート（例: USB1）を選んだ後、緑色の「Connect」ボタンをクリックして基板と接続します。

![STM32CubeProgrammerの接続設定](./document/SS_1.png)

4. 接続が成功したら、画面左上の「Open file」タブをクリックします。
5. ファイル選択ダイアログが開くので、ビルド済みの `.bin` ファイル（例: `Leverless_Controller.bin`）を選択して開きます。

![バイナリファイルの選択](./document/SS_2.png)

6. ファイルを読み込んだ後、「Download」ボタンをクリックしてファームウェアの書き込み（インストール）を実行します。完了メッセージが表示されれば、デバイスの初期セットアップは完了です！

### 2. 起動モードの選択
本デバイスには2つの動作モードがあります。

- **ゲームモード (通常起動):**
  そのままUSBを接続します。Windowsから「Xbox 360 Controller」として認識され、すぐにゲームで使用可能です。
- **設定モード (ボタン押下起動):**
  **UPボタン**を押しながらUSBを接続し、**数秒待ってから指を離します**。
  デバイスマネージャー等でカスタムHIDデバイスとして認識され、ブラウザからの設定が可能になります。
  *(※起動時にキャリブレーションを行うため、指を離すまで入力は反映されません)*

### 3. Web Configurator による設定
1. 設定モードでデバイスをPCに接続します。
2. 使用しているキースイッチに合わせて、以下のいずれかの設定ページをブラウザ（Chrome/Edge）で開きます。

   - **通常版 (3.2mm / Jade Ultra 等):**
     [https://ltsul4.github.io/hallsenser-leverless-439/WebDriver/WebDriver.html](https://ltsul4.github.io/hallsenser-leverless-439/WebDriver/WebDriver.html)

   - **特別版 (3.5mm / Jade Pro 専用):**
     [https://ltsul4.github.io/hallsenser-leverless-439/WebDriver/WebDriver3.5.html](https://ltsul4.github.io/hallsenser-leverless-439/WebDriver/WebDriver3.5.html)

3. 「接続」ボタンを押し、リストから該当するデバイス（Vendor ID: `0x0483` / Product ID: `0x5751`）を選択します。
4. 画面上のビジュアライザーで各キーの動きを確認しながら、AP（作動点）やRT（感度）を調整してください。
5. 設定完了後、「設定を保存」を押すことでマイコン内部のFlashメモリに設定が永続保存されます。

---

## 開発状況

- [x] ホールセンサーによるアナログ値の取得
- [x] ラピッドトリガー・可変作動点アルゴリズムの実装
- [x] WebHID / WebUSB による設定ツールの構築 (`WebDriver.html`)
- [x] Flashメモリへの設定保存機能
- [x] 同時押し（コンボ）ボタン機能の実装
- [x] 入力切断（セーフティ）機能の実装

---

## クレジット・参考元

本プロジェクトの制作にあたり、以下のプロジェクトを参考にさせていただきました。
- **参考元:** [kenyoshizoe/ember](https://github.com/kenyoshizoe/ember)

また、本プロジェクトのコードおよびドキュメントの一部は、**Gemini** および **Google AI Studio** を活用して作成されました。

---

## ライセンス

**MIT License**

本プロジェクトは卒業制作として継続的に開発されています。温かい目で見守っていただければ幸いです。