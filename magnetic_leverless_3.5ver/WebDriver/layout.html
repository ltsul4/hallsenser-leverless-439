<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Layout Editor</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; margin: 0; overflow: hidden; }
        
        .toolbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: #333; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 1000;
            border-bottom: 1px solid #555; gap: 10px;
        }
        .toolbar button, .toolbar input { cursor: pointer; }
        
        .canvas-container {
            position: absolute; top: 60px; left: 0; right: 0; bottom: 0;
            display: flex; justify-content: center; align-items: center;
            background: #222; overflow: auto;
        }
        
        /* 天板エリア */
        .controller-board {
            /* 画像の比率に合わせて初期サイズを設定 (後で画像に合わせてリサイズされます) */
            width: 1000px; height: 700px;
            background-color: #2a2a2a; 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 2px solid #444; 
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .btn-circle {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(0, 255, 204, 0.2);
            border: 2px solid #00ffcc;
            position: absolute;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: grab; user-select: none;
            color: #fff; text-shadow: 1px 1px 2px #000;
            font-size: 12px;
            transition: transform 0.1s;
        }
        .btn-circle:active { cursor: grabbing; transform: scale(1.1); background: rgba(0, 255, 204, 0.5); }
        .btn-circle.selected { border-color: #ffaa00; z-index: 100; }
        
        #outputArea {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
            background: #111; color: #0f0; font-family: monospace;
            border-top: 1px solid #555; padding: 10px; box-sizing: border-box;
            display: none; z-index: 2000;
        }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="bgLoader" accept="image/*">
    <button onclick="exportLayout()">配置データを出力</button>
    <div style="font-size:12px; color:#aaa; margin-left:auto;">
        1. 画像を読み込む -> 2. ボタンを穴に合わせる -> 3. 出力してチャットに貼る
    </div>
</div>

<div class="canvas-container">
    <div class="controller-board" id="board">
        <!-- ボタンはJSで生成 -->
    </div>
</div>

<textarea id="outputArea"></textarea>

<script>
    // main.c の keyNames と同じ順序
    const keyNames = [
        "Right", "Down", "Left", "Btn16", "Btn8", "Btn7", "Btn15", "Btn14",
        "Btn13", "Btn12", "Btn11", "Btn10", "Btn9", "Btn3", "Btn4", "Btn5",
        "Btn6", "Btn2", "Up", "Btn1"
    ];

    const board = document.getElementById('board');
    
    // 背景画像読み込み処理
    document.getElementById('bgLoader').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // ボードのサイズを画像のアスペクト比に合わせる
                // 画面に収まるように調整
                const maxWidth = window.innerWidth - 100;
                const maxHeight = window.innerHeight - 150;
                
                let w = img.width;
                let h = img.height;
                
                if (w > maxWidth) {
                    const ratio = maxWidth / w;
                    w = maxWidth;
                    h = h * ratio;
                }
                
                board.style.width = w + 'px';
                board.style.height = h + 'px';
                board.style.backgroundImage = `url('${event.target.result}')`;
            }
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    // ボタン生成
    keyNames.forEach((name, i) => {
        const btn = document.createElement('div');
        btn.className = 'btn-circle';
        btn.id = `btn-${i}`;
        btn.innerHTML = `<span>${name}</span><span style="font-size:9px">ID:${i}</span>`;
        
        // 初期配置（左上に固める）
        const col = i % 5;
        const row = Math.floor(i / 5);
        btn.style.left = (10 + col * 60) + 'px';
        btn.style.top = (10 + row * 60) + 'px';
        
        makeDraggable(btn);
        board.appendChild(btn);
    });

    // ドラッグ処理
    function makeDraggable(el) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        el.addEventListener('mousedown', (e) => {
            isDragging = true;
            el.classList.add('selected');
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = el.offsetLeft;
            initialTop = el.offsetTop;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            el.style.left = `${initialLeft + dx}px`;
            el.style.top = `${initialTop + dy}px`;
        });

        window.addEventListener('mouseup', () => {
            if(isDragging) {
                isDragging = false;
                el.classList.remove('selected');
            }
        });
    }

    // データ出力
    function exportLayout() {
        const layoutData = [];
        const w = board.offsetWidth;
        const h = board.offsetHeight;
        
        keyNames.forEach((name, i) => {
            const btn = document.getElementById(`btn-${i}`);
            // 中心座標を計算して％に変換
            const cx = btn.offsetLeft + (btn.offsetWidth / 2);
            const cy = btn.offsetTop + (btn.offsetHeight / 2);
            
            layoutData.push({
                id: i,
                name: name,
                left: ((cx / w) * 100).toFixed(2) + "%",
                top: ((cy / h) * 100).toFixed(2) + "%"
            });
        });
        
        const json = JSON.stringify(layoutData, null, 2);
        const out = document.getElementById('outputArea');
        out.style.display = 'block';
        out.value = json;
        out.select();
        document.execCommand('copy');
        alert("データを出力しました。コピーされたテキストをチャットに貼り付けてください。");
    }
</script>
</body>
</html>