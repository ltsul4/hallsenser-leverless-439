<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magnetic Leverless Controller</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --accent-color: #00ffcc;
            --accent-active: #ff4444;
            --text-color: #e0e0e0;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- Header & Toolbar --- */
        header {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            box-sizing: border-box;
            z-index: 100;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.2rem; color: var(--accent-color); letter-spacing: 1px; }

        .toolbar { display: flex; gap: 10px; align-items: center; }

        button {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            transition: all 0.2s; font-weight: bold; font-size: 0.9rem;
            white-space: nowrap;
        }
        button:hover:not(:disabled) { background: #444; border-color: #777; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        button.connect { background: #0066cc; border-color: #0055aa; }
        button.connect:hover:not(:disabled) { background: #0077dd; }
        
        button.save { background: #28a745; border-color: #1e7e34; }
        button.save:hover:not(:disabled) { background: #34ce57; }

        button.calib { background: #ffaa00; color: #000; border-color: #cc8800; }

        button.stop-input { background: #ff4444; border-color: #cc0000; }
        button.stop-input.active { background: #333; border-color: #555; }

        select {
            background: #333; color: #fff; border: 1px solid #555;
            padding: 8px; border-radius: 6px;
        }

        /* --- Main Layout Area --- */
        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Left: Visual Controller */
        .visual-area {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #2a2a2a 0%, #121212 100%);
            overflow: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
        }

        .board-container {
            width: 1120px; 
            height: 700px;
            position: relative;
            flex-shrink: 0; 
            margin: 50px; 
        }

        .select-all-btn {
            position: absolute;
            top: 20px; left: 20px;
            z-index: 50;
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        .select-all-btn:hover {
            background: rgba(0, 255, 204, 0.3);
        }

        .btn-visual {
            position: absolute;
            width: 72px; height: 72px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #555;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 10;
            overflow: hidden; 
        }

        .btn-visual:hover { border-color: #888; }

        .btn-visual.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            z-index: 20;
            background: rgba(0, 255, 204, 0.1);
        }

        .btn-visual .fill {
            position: absolute;
            bottom: 0; left: 0; 
            width: 100%; 
            height: 0%; 
            background: var(--accent-color);
            opacity: 0.6; 
            transition: height 0.05s; 
            z-index: 1;
            border-radius: 0; 
        }
        
        .btn-visual.active .fill { background: var(--accent-active); opacity: 0.8; }

        .btn-label-map {
            position: relative; z-index: 2;
            font-size: 18px; font-weight: 800;
            color: #fff;
            pointer-events: none; text-shadow: 0 0 3px #000;
            line-height: 1.2;
        }
        .btn-label-phy {
            position: relative; z-index: 2;
            font-size: 11px; font-weight: normal;
            color: #ccc;
            pointer-events: none; text-shadow: 0 0 2px #000;
        }

        /* Right: Settings Panel */
        .settings-panel {
            width: 380px;
            background: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 50;
            flex-shrink: 0;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        .settings-panel.hidden { display: none; }

        .empty-state {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            height: 100%; color: #666; text-align: center;
        }

        .panel-header {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .panel-header h2 { margin: 0; color: var(--accent-color); }
        .key-id-display { font-size: 0.8rem; color: #888; }

        .control-group {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .control-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc; font-weight: 600; }
        
        .slider-row { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--accent-color); }
        input[type="number"] { width: 50px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 4px; }

        .bar-container {
            height: 150px;
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            position: relative;
            margin-top: 10px;
            overflow: hidden;
        }
        .bar-fill {
            position: absolute; bottom: 0; width: 100%;
            background: linear-gradient(to top, var(--accent-color), #0088ff);
            height: 0%;
            transition: height 0.05s;
        }
        .bar-fill.active { background: var(--accent-active); }

        .line { position: absolute; width: 100%; height: 2px; z-index: 5; pointer-events: none; }
        .line-ap { border-top: 2px dashed #ff4444; }
        .line-anchor { background: #ffff00; }
        .line-off { background: #888; }

        .status-text { font-size: 0.8rem; text-align: right; margin-top: 5px; color: #888; }

        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
            backdrop-filter: blur(2px);
        }
        .overlay-msg { font-size: 1.5rem; color: #fff; }
        .hidden { display: none; }

        /* Combo Editor Styles - Optimized */
        .combo-tabs { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .combo-tab { 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: #333; border: 2px solid #555;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 0.9rem; font-weight: bold;
            transition: all 0.2s;
        }
        .combo-tab:hover { border-color: #888; }
        .combo-tab.active { 
            background: var(--accent-color); color: #000; border-color: var(--accent-color); 
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.4);
        }
        
        .combo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .combo-check { 
            display: flex; align-items: center; justify-content: center;
            background: #333; padding: 8px; border-radius: 6px; cursor: pointer;
            font-size: 0.85rem; border: 1px solid #444; transition: all 0.1s;
        }
        .combo-check:hover { background: #444; }
        .combo-check.checked { background: #0066cc; border-color: #0088ff; color: #fff; font-weight: bold; }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 1rem;
            border: 1px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

    </style>
</head>
<body>

<header>
    <h1>Magnetic Leverless</h1>
    <div class="toolbar">
        <select id="socdSelect" disabled onchange="sendSOCD()">
            <option value="0">SOCD: ニュートラル (CPT)</option>
            <option value="1">SOCD: 上優先 (Hitbox)</option>
            <option value="2">SOCD: 後押し優先 (Last Win)</option>
        </select>
        <button class="stop-input" id="btnToggleInput" disabled onclick="toggleInput()">入力停止</button>
        <button class="calib" id="btnCalib" disabled onclick="sendCalibrate()">キャリブレーション</button>
        <button class="save" id="btnSave" disabled onclick="sendSave()">設定を保存</button>
        <button class="connect" id="btnConnect" onclick="connectDevice()">接続</button>
    </div>
</header>

<div class="main-container">
    <!-- 左側: ビジュアル配置 -->
    <div class="visual-area" id="visualArea" onclick="deselectKey()">
        <button class="select-all-btn" onclick="toggleSelectAll(event)">全選択 / 解除</button>
        
        <div class="board-container" id="board">
            <!-- ボタンはJSで生成 -->
        </div>
        
        <div id="disconnectOverlay" class="overlay">
            <div class="overlay-msg">デバイス未接続</div>
        </div>
    </div>

    <!-- 右側: 設定パネル -->
    <div class="settings-panel" id="settingsPanel">
        <div id="emptyState" class="empty-state">
            <p>ボタンを選択して<br>設定を変更してください<br><small>(Ctrl+クリックで複数選択)</small></p>
        </div>

        <div id="settingsContent" class="hidden">
            <div class="panel-header">
                <h2 id="selectedKeyName">Key Name</h2>
                <div class="key-id-display" id="selectedKeyId">ID: -</div>
            </div>

            <div class="control-group">
                <label>ボタン割り当て</label>
                <select id="mapSelect" onchange="updateMapping()" style="width:100%">
                    <!-- JSで生成 -->
                </select>
            </div>

            <div class="control-group">
                <label>Actuation Point (ON位置)</label>
                <div class="slider-row">
                    <input type="range" id="apRange" min="1" max="30" oninput="uiSync('ap')">
                    <input type="number" id="apNum" step="0.1" min="0.1" max="3.0" onchange="uiSync('ap', true)"> mm
                </div>
            </div>

            <div class="control-group">
                <label>Rapid Trigger (感度)</label>
                <div class="slider-row">
                    <input type="range" id="rtRange" min="1" max="30" oninput="uiSync('rt')">
                    <input type="number" id="rtNum" step="0.1" min="0.1" max="3.0" onchange="uiSync('rt', true)"> mm
                </div>
            </div>

            <div class="control-group">
                <label>Top Deadzone (指置き誤爆防止)</label>
                <div class="slider-row">
                    <input type="range" id="topRange" min="0" max="20" oninput="uiSync('top')">
                    <input type="number" id="topNum" step="0.01" min="0.0" max="0.2" onchange="uiSync('top', true)"> mm
                </div>
            </div>

            <div class="control-group">
                <label>Bottom Deadzone (底打ち誤爆防止)</label>
                <div class="slider-row">
                    <input type="range" id="btmRange" min="0" max="20" oninput="uiSync('btm')">
                    <input type="number" id="btmNum" step="0.01" min="0.0" max="0.2" onchange="uiSync('btm', true)"> mm
                </div>
            </div>

            <div class="control-group">
                <label>リアルタイム動作 (最終選択キー)</label>
                <div class="bar-container">
                    <div id="visApLine" class="line line-ap"></div>
                    <div id="visAnchorLine" class="line line-anchor" style="display:none"></div>
                    <div id="visOffLine" class="line line-off" style="display:none"></div>
                    <div id="visBar" class="bar-fill"></div>
                </div>
                <div class="status-text">
                    現在値: <span id="visVal">0.00</span> mm
                </div>
            </div>
        </div>

        <!-- コンボエディタ -->
        <div class="control-group" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
            <label style="color:var(--accent-color); text-align:center; margin-bottom:15px;">同時押し設定 (C1-C4)</label>
            <div class="combo-tabs" id="comboTabs">
                <div class="combo-tab active" onclick="selectComboTab(0)">C1</div>
                <div class="combo-tab" onclick="selectComboTab(1)">C2</div>
                <div class="combo-tab" onclick="selectComboTab(2)">C3</div>
                <div class="combo-tab" onclick="selectComboTab(3)">C4</div>
            </div>
            
            <div class="combo-grid" id="comboGrid">
                <!-- JSで生成 -->
            </div>
        </div>
    </div>
</div>

<div id="toast">Notification Message</div>

<script>
    // --- Constants & Config ---
    const CMD_GET_CONFIG    = 0x10;
    const CMD_GET_COMBOS    = 0x11;
    const CMD_SET_CONFIG    = 0x20;
    const CMD_READ_SENSORS  = 0x30;
    const CMD_CALIBRATE     = 0x40;
    const CMD_SAVE_SETTINGS = 0x50;
    const CMD_SET_SOCD      = 0x60;
    const CMD_SET_MAPPING   = 0x70;
    const CMD_STOP_INPUT    = 0x80;
    const CMD_SET_COMBO     = 0x81;
    
    const REPORT_ID = 0;
    const KEY_COUNT = 20;
    const COMBO_COUNT = 4;

    const layoutData = [
        { "id": 0, "name": "Right", "left": "45.00%", "top": "36.82%" },
        { "id": 1, "name": "Down", "left": "37.39%", "top": "31.74%" },
        { "id": 2, "name": "Left", "left": "28.13%", "top": "31.74%" },
        { "id": 3, "name": "Btn16", "left": "19.18%", "top": "36.41%" },
        { "id": 4, "name": "Btn8", "left": "40.97%", "top": "14.30%" },
        { "id": 5, "name": "Btn7", "left": "31.72%", "top": "14.10%" },
        { "id": 6, "name": "Btn15", "left": "22.61%", "top": "14.10%" },
        { "id": 7, "name": "Btn14", "left": "13.36%", "top": "14.10%" },
        { "id": 8, "name": "Btn13", "left": "78.58%", "top": "28.90%" },
        { "id": 9, "name": "Btn12", "left": "70.07%", "top": "27.69%" },
        { "id": 10, "name": "Btn11", "left": "61.12%", "top": "27.69%" },
        { "id": 11, "name": "Btn10", "left": "53.51%", "top": "32.56%" },
        { "id": 12, "name": "Btn9", "left": "54.10%", "top": "20.59%" },
        { "id": 13, "name": "Btn3", "left": "52.61%", "top": "44.32%" },
        { "id": 14, "name": "Btn4", "left": "60.52%", "top": "40.06%" },
        { "id": 15, "name": "Btn5", "left": "69.93%", "top": "40.06%" },
        { "id": 16, "name": "Btn6", "left": "78.58%", "top": "41.68%" },
        { "id": 17, "name": "Btn2", "left": "38.58%", "top": "61.56%" },
        { "id": 18, "name": "Up", "left": "49.93%", "top": "61.56%" },
        { "id": 19, "name": "Btn1", "left": "57.54%", "top": "54.06%" }
    ];

    const buttonMap = [
        { id: 0, name: "なし" },
        { id: 1, name: "UP" }, { id: 2, name: "DOWN" }, { id: 3, name: "LEFT" }, { id: 4, name: "RIGHT" },
        { id: 12, name: "A" }, { id: 13, name: "B" }, { id: 14, name: "X" }, { id: 15, name: "Y" },
        { id: 9, name: "LB" }, { id: 10, name: "RB" }, { id: 16, name: "LT" }, { id: 17, name: "RT" },
        { id: 5, name: "START" }, { id: 6, name: "BACK" }, { id: 11, name: "GUIDE" },
        { id: 7, name: "L3" }, { id: 8, name: "R3" },
        { id: 100, name: "C1" }, { id: 101, name: "C2" },
        { id: 102, name: "C3" }, { id: 103, name: "C4" }
    ];

    const COMBO_OPTIONS = [
        { name: "A", mask: 0x1000 }, { name: "B", mask: 0x2000 },
        { name: "X", mask: 0x4000 }, { name: "Y", mask: 0x8000 },
        { name: "RB", mask: 0x0200 }, { name: "LB", mask: 0x0100 },
        { name: "RT", mask: 0, isTrig: true, trig: 'rt' }, { name: "LT", mask: 0, isTrig: true, trig: 'lt' },
        { name: "UP", mask: 0x0001 }, { name: "DWN", mask: 0x0002 },
        { name: "LFT", mask: 0x0004 }, { name: "RGT", mask: 0x0008 },
        { name: "ST", mask: 0x0010 }, { name: "BK", mask: 0x0020 },
        { name: "L3", mask: 0x0040 }, { name: "R3", mask: 0x0080 }
    ];

    // --- State ---
    let device = null;
    let selectedKeyIndices = [];
    let keysConfig = Array(KEY_COUNT).fill().map(() => ({ ap: 1.2, rt: 0.5, top: 0.2, btm: 0.1, map: 0 }));
    let isInputEnabled = true;
    let comboSettings = Array(COMBO_COUNT).fill().map(() => ({ mask: 0, lt: 0, rt: 0 }));
    let currentComboTab = 0;

    // --- Initialization ---
    window.onload = () => {
        initBoard();
        initMapSelect();
        renderComboGrid();
    };

    function initBoard() {
        const board = document.getElementById('board');
        layoutData.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'btn-visual';
            btn.id = `btn-${item.id}`;
            btn.style.left = item.left;
            btn.style.top = item.top;
            
            btn.onclick = (e) => {
                e.stopPropagation();
                selectKey(item.id, e.ctrlKey || e.metaKey);
            };
            
            btn.innerHTML = `
                <div class="fill" id="fill-${item.id}"></div>
                <div class="btn-label-map" id="lbl-map-${item.id}">-</div>
                <div class="btn-label-phy">${item.name}</div>
            `;
            board.appendChild(btn);
        });
    }

    function initMapSelect() {
        const sel = document.getElementById('mapSelect');
        buttonMap.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id;
            opt.innerText = b.name;
            sel.appendChild(opt);
        });
    }

    function updateButtonLabels() {
        for(let i=0; i<KEY_COUNT; i++) {
            const mapId = keysConfig[i].map;
            const mapObj = buttonMap.find(b => b.id === mapId);
            const name = mapObj ? mapObj.name : "???";
            document.getElementById(`lbl-map-${i}`).innerText = (mapId === 0) ? "-" : name;
        }
    }

    // --- Interaction ---
    function selectKey(id, isMulti) {
        if (isMulti) {
            const idx = selectedKeyIndices.indexOf(id);
            if (idx !== -1) {
                selectedKeyIndices.splice(idx, 1);
                document.getElementById(`btn-${id}`).classList.remove('selected');
            } else {
                selectedKeyIndices.push(id);
                document.getElementById(`btn-${id}`).classList.add('selected');
            }
        } else {
            selectedKeyIndices.forEach(i => {
                document.getElementById(`btn-${i}`).classList.remove('selected');
            });
            selectedKeyIndices = [id];
            document.getElementById(`btn-${id}`).classList.add('selected');
        }
        updatePanel();
    }

    function toggleSelectAll(e) {
        e.stopPropagation();
        if (selectedKeyIndices.length === KEY_COUNT) {
            deselectKey();
        } else {
            selectedKeyIndices = [];
            for(let i=0; i<KEY_COUNT; i++) {
                selectedKeyIndices.push(i);
                document.getElementById(`btn-${i}`).classList.add('selected');
            }
            updatePanel();
        }
    }

    function deselectKey() {
        selectedKeyIndices.forEach(i => {
            document.getElementById(`btn-${i}`).classList.remove('selected');
        });
        selectedKeyIndices = [];
        updatePanel();
    }

    function updatePanel() {
        if (selectedKeyIndices.length === 0) {
            document.getElementById('settingsContent').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }

        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('settingsContent').classList.remove('hidden');

        const lastId = selectedKeyIndices[selectedKeyIndices.length - 1];
        const keyData = layoutData.find(k => k.id === lastId);
        
        if (selectedKeyIndices.length > 1) {
            document.getElementById('selectedKeyName').innerText = `${selectedKeyIndices.length} keys selected`;
            document.getElementById('selectedKeyId').innerText = `Last: ${keyData.name}`;
            document.getElementById('mapSelect').disabled = true;
        } else {
            document.getElementById('selectedKeyName').innerText = keyData.name;
            document.getElementById('selectedKeyId').innerText = `ID: ${lastId}`;
            document.getElementById('mapSelect').disabled = false;
        }
        
        const conf = keysConfig[lastId];
        document.getElementById('apNum').value = conf.ap.toFixed(1);
        document.getElementById('apRange').value = Math.round(conf.ap * 10);
        document.getElementById('rtNum').value = conf.rt.toFixed(1);
        document.getElementById('rtRange').value = Math.round(conf.rt * 10);
        
        document.getElementById('topNum').value = conf.top.toFixed(2);
        document.getElementById('topRange').value = Math.round(conf.top * 100);
        document.getElementById('btmNum').value = conf.btm.toFixed(2);
        document.getElementById('btmRange').value = Math.round(conf.btm * 100);

        document.getElementById('mapSelect').value = conf.map;

        if (conf.map >= 100 && conf.map <= 103) {
            selectComboTab(conf.map - 100);
        }

        updateVisLines(conf.ap, conf.rt);
    }

    function uiSync(type, fromNum = false) {
        if (selectedKeyIndices.length === 0) return;
        
        const range = document.getElementById(`${type}Range`);
        const num = document.getElementById(`${type}Num`);
        
        let val;
        if (type === 'top' || type === 'btm') {
            if (fromNum) {
                val = parseFloat(num.value);
                range.value = Math.round(val * 100);
            } else {
                val = parseInt(range.value) / 100;
                num.value = val.toFixed(2);
            }
        } else {
            if (fromNum) {
                val = parseFloat(num.value);
                range.value = Math.round(val * 10);
            } else {
                val = parseInt(range.value) / 10;
                num.value = val.toFixed(1);
            }
        }

        selectedKeyIndices.forEach(id => {
            if (type === 'ap') keysConfig[id].ap = val;
            if (type === 'rt') keysConfig[id].rt = val;
            if (type === 'top') keysConfig[id].top = val;
            if (type === 'btm') keysConfig[id].btm = val;
            sendConfig(id);
        });

        const lastId = selectedKeyIndices[selectedKeyIndices.length - 1];
        updateVisLines(keysConfig[lastId].ap, keysConfig[lastId].rt);
    }

    function updateMapping() {
        if (selectedKeyIndices.length !== 1) return;
        const id = selectedKeyIndices[0];
        const val = parseInt(document.getElementById('mapSelect').value);
        keysConfig[id].map = val;
        sendMapping(id, val);
        updateButtonLabels();

        if (val >= 100 && val <= 103) {
            selectComboTab(val - 100);
        }
    }

    function updateVisLines(ap, rt) {
        const apPct = (ap / 3.2) * 100;
        document.getElementById('visApLine').style.bottom = `${apPct}%`;
    }

    // --- Combo Editor Logic ---
    function selectComboTab(idx) {
        currentComboTab = idx;
        const tabs = document.querySelectorAll('.combo-tab');
        tabs.forEach((t, i) => {
            if (i === idx) t.classList.add('active');
            else t.classList.remove('active');
        });
        renderComboGrid();
    }

    function toggleComboBit(optIdx) {
        const opt = COMBO_OPTIONS[optIdx];
        const setting = comboSettings[currentComboTab];
        
        if (opt.isTrig) {
            if (opt.trig === 'lt') setting.lt = setting.lt ? 0 : 1;
            if (opt.trig === 'rt') setting.rt = setting.rt ? 0 : 1;
        } else {
            setting.mask ^= opt.mask;
        }
        renderComboGrid();
        sendCombo(currentComboTab);
    }

    function renderComboGrid() {
        const container = document.getElementById('comboGrid');
        container.innerHTML = '';
        const setting = comboSettings[currentComboTab];

        COMBO_OPTIONS.forEach((opt, idx) => {
            let isChecked = false;
            if (opt.isTrig) {
                if (opt.trig === 'lt') isChecked = (setting.lt === 1);
                if (opt.trig === 'rt') isChecked = (setting.rt === 1);
            } else {
                isChecked = (setting.mask & opt.mask) !== 0;
            }

            const div = document.createElement('div');
            div.className = isChecked ? 'combo-check checked' : 'combo-check';
            div.onclick = () => toggleComboBit(idx);
            div.innerText = opt.name;
            container.appendChild(div);
        });
    }

    // --- Toast Notification ---
    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.className = "show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    // --- WebHID Communication ---
    async function connectDevice() {
        try {
            const devices = await navigator.hid.requestDevice({
                filters: [
                    { vendorId: 0x0483, productId: 0x5751 },
                    { vendorId: 0x045e, productId: 0x028e }
                ]
            });

            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                
                document.getElementById('disconnectOverlay').classList.add('hidden');
                document.getElementById('btnConnect').innerText = "接続済み";
                document.getElementById('btnConnect').disabled = true;
                document.getElementById('btnCalib').disabled = false;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('socdSelect').disabled = false;
                document.getElementById('btnToggleInput').disabled = false;

                device.addEventListener('inputreport', handleInputReport);
                await readConfig();
                await readCombos();
                startPolling();
                deselectKey();
                showToast("デバイスに接続しました");
            }
        } catch (e) {
            console.error(e);
            showToast("接続できませんでした");
        }
    }

    async function startPolling() {
        while (device && device.opened) {
            try {
                const data = new Uint8Array(64);
                data[0] = CMD_READ_SENSORS;
                await device.sendReport(REPORT_ID, data);
                await new Promise(r => setTimeout(r, 10));
            } catch (e) { break; }
        }
    }

    async function readConfig() {
        const data = new Uint8Array(64);
        data[0] = CMD_GET_CONFIG;
        await device.sendReport(REPORT_ID, data);
    }

    async function readCombos() {
        const data = new Uint8Array(64);
        data[0] = CMD_GET_COMBOS;
        await device.sendReport(REPORT_ID, data);
    }

    function handleInputReport(event) {
        const { data } = event;
        const cmd = data.getUint8(0);

        if (cmd === CMD_READ_SENSORS) {
            for (let i = 0; i < KEY_COUNT; i++) {
                const rawPos = data.getUint8(i + 1);
                const isPressed = data.getUint8(i + 21) === 1;
                const rawAnchor = data.getUint8(i + 41);

                const fill = document.getElementById(`fill-${i}`);
                const btn = document.getElementById(`btn-${i}`);
                if (fill) {
                    fill.style.height = `${(rawPos / 255) * 100}%`;
                    if (isPressed) btn.classList.add('active');
                    else btn.classList.remove('active');
                }

                if (selectedKeyIndices.length > 0 && i === selectedKeyIndices[selectedKeyIndices.length - 1]) {
                    const mm = (rawPos / 255) * 3.2;
                    const anchorMm = (rawAnchor / 255) * 3.2;
                    const rtVal = keysConfig[i].rt;

                    document.getElementById('visVal').innerText = mm.toFixed(2);
                    
                    const bar = document.getElementById('visBar');
                    bar.style.height = `${(rawPos / 255) * 100}%`;
                    if (isPressed) bar.classList.add('active');
                    else bar.classList.remove('active');

                    const anchorLine = document.getElementById('visAnchorLine');
                    const offLine = document.getElementById('visOffLine');

                    if (isPressed) {
                        anchorLine.style.display = 'block';
                        anchorLine.style.bottom = `${(rawAnchor / 255) * 100}%`;
                        offLine.style.display = 'block';
                        let offMm = anchorMm - rtVal;
                        if (offMm < 0) offMm = 0;
                        offLine.style.bottom = `${(offMm / 3.2) * 100}%`;
                    } else {
                        anchorLine.style.display = 'none';
                        offLine.style.display = 'none';
                    }
                }
            }
        }
        else if (cmd === CMD_GET_CONFIG) {
            const socd = data.getUint8(1);
            document.getElementById('socdSelect').value = socd;

            for (let i = 0; i < KEY_COUNT; i++) {
                keysConfig[i].ap = data.getUint8(i + 2) / 10.0;
                keysConfig[i].rt = data.getUint8(i + 22) / 10.0;
                keysConfig[i].map = data.getUint8(i + 42);
            }
            deselectKey();
            updateButtonLabels();
        }
        else if (cmd === CMD_GET_COMBOS) {
            for (let i = 0; i < COMBO_COUNT; i++) {
                const offset = 1 + (i * 4);
                comboSettings[i].mask = data.getUint8(offset) | (data.getUint8(offset+1) << 8);
                comboSettings[i].lt = data.getUint8(offset+2);
                comboSettings[i].rt = data.getUint8(offset+3);
            }
            renderComboGrid();
        }
    }

    async function sendConfig(id) {
        if (!device) return;
        const conf = keysConfig[id];
        const data = new Uint8Array(64);
        data[0] = CMD_SET_CONFIG;
        data[1] = id;
        data[2] = Math.round(conf.ap * 10);
        data[3] = Math.round(conf.rt * 10);
        data[4] = Math.round(conf.top * 100);
        data[5] = Math.round(conf.btm * 100);
        await device.sendReport(REPORT_ID, data);
    }

    async function sendMapping(id, mapVal) {
        if (!device) return;
        const data = new Uint8Array(64);
        data[0] = CMD_SET_MAPPING;
        data[1] = id;
        data[2] = mapVal;
        await device.sendReport(REPORT_ID, data);
    }

    async function sendSOCD() {
        if (!device) return;
        const val = document.getElementById('socdSelect').value;
        const data = new Uint8Array(64);
        data[0] = CMD_SET_SOCD;
        data[1] = parseInt(val);
        await device.sendReport(REPORT_ID, data);
    }

    async function sendCalibrate() {
        if (!device) return;
        const data = new Uint8Array(64);
        data[0] = CMD_CALIBRATE;
        await device.sendReport(REPORT_ID, data);
        showToast("キャリブレーション完了");
    }

    async function sendSave() {
        if (!device) return;
        const data = new Uint8Array(64);
        data[0] = CMD_SAVE_SETTINGS;
        await device.sendReport(REPORT_ID, data);
        showToast("設定を保存しました");
    }

    async function toggleInput() {
        if (!device) return;
        isInputEnabled = !isInputEnabled;
        
        const data = new Uint8Array(64);
        data[0] = CMD_STOP_INPUT;
        data[1] = isInputEnabled ? 1 : 0;
        await device.sendReport(REPORT_ID, data);

        const btn = document.getElementById('btnToggleInput');
        if (isInputEnabled) {
            btn.innerText = "入力停止";
            btn.classList.remove('active');
        } else {
            btn.innerText = "入力再開";
            btn.classList.add('active');
        }
    }

    async function sendCombo(idx) {
        if (!device) return;
        
        const setting = comboSettings[idx];
        const data = new Uint8Array(64);
        data[0] = CMD_SET_COMBO;
        data[1] = idx; 
        
        data[2] = setting.mask & 0xFF;
        data[3] = (setting.mask >> 8) & 0xFF;
        data[4] = setting.lt;
        data[5] = setting.rt;
        
        await device.sendReport(REPORT_ID, data);
    }
</script>
</body>
</html>
